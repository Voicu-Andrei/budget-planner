{% extends "base.html" %}

{% block title %}Prediction - Budget Planner{% endblock %}

{% block content %}
<div class="prediction-page">
    <h1>What Will Happen Next Month?</h1>

    <div class="card">
        <p class="description">
            Using Monte Carlo simulation, we'll run 1,000 different scenarios based on your spending patterns
            to predict your most likely financial outcomes next month.
        </p>

        <button id="run-simulation-btn" onclick="runSimulation()" class="btn btn-primary btn-large">
            ðŸŽ² Run Prediction Simulation
        </button>

        <div id="simulation-loading" class="loading-container" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Running 1,000 simulations...</p>
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
        </div>
    </div>

    <div id="results-container" style="display: none;">
        <!-- Results will appear here -->
        <div class="card">
            <h2>Predicted Ending Balance</h2>
            <canvas id="histogram-chart"></canvas>
        </div>

        <div class="card">
            <h2>Probability Statistics</h2>
            <div class="probability-grid">
                <div class="probability-box success">
                    <div class="probability-value" id="prob-positive">-</div>
                    <div class="probability-label">Chance of positive balance</div>
                </div>

                <div class="probability-box warning">
                    <div class="probability-value" id="prob-overbudget">-</div>
                    <div class="probability-label">Chance of going over budget</div>
                </div>

                <div class="probability-box info">
                    <div class="probability-value" id="prob-savings">-</div>
                    <div class="probability-label">Chance of meeting savings goal</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Scenario Breakdown</h2>
            <div class="scenarios-grid">
                <div class="scenario-box">
                    <div class="scenario-label">Best Case (top 10%)</div>
                    <div class="scenario-value" id="best-case">-</div>
                </div>

                <div class="scenario-box">
                    <div class="scenario-label">Likely Case (middle 50%)</div>
                    <div class="scenario-value" id="likely-case">-</div>
                </div>

                <div class="scenario-box">
                    <div class="scenario-label">Worst Case (bottom 10%)</div>
                    <div class="scenario-value" id="worst-case">-</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>"What If" Scenarios</h2>
            <p>Adjust your spending in different categories to see how it affects your outcomes.</p>

            <div class="what-if-grid">
                <div class="what-if-item">
                    <label>Food & Groceries</label>
                    <input type="range" id="adj-food" min="-200" max="200" value="0" step="10">
                    <span id="val-food">$0</span>
                </div>

                <div class="what-if-item">
                    <label>Dining Out</label>
                    <input type="range" id="adj-dining" min="-200" max="200" value="0" step="10">
                    <span id="val-dining">$0</span>
                </div>

                <div class="what-if-item">
                    <label>Entertainment</label>
                    <input type="range" id="adj-entertainment" min="-200" max="200" value="0" step="10">
                    <span id="val-entertainment">$0</span>
                </div>

                <div class="what-if-item">
                    <label>Shopping</label>
                    <input type="range" id="adj-shopping" min="-200" max="200" value="0" step="10">
                    <span id="val-shopping">$0</span>
                </div>
            </div>

            <button onclick="runWhatIfSimulation()" class="btn btn-primary">Recalculate with Adjustments</button>

            <div id="what-if-result" class="what-if-result" style="display: none;">
                <h3>New Prediction:</h3>
                <p id="what-if-text"></p>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    let currentResults = null;
    let histogramChart = null;

    // Update slider values
    ['food', 'dining', 'entertainment', 'shopping'].forEach(cat => {
        const slider = document.getElementById(`adj-${cat}`);
        const display = document.getElementById(`val-${cat}`);

        slider.addEventListener('input', (e) => {
            const value = parseInt(e.target.value);
            display.textContent = (value >= 0 ? '+' : '') + '$' + value;
        });
    });

    function runSimulation() {
        document.getElementById('run-simulation-btn').style.display = 'none';
        document.getElementById('simulation-loading').style.display = 'block';

        // Simulate progress
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 10;
            document.getElementById('progress-fill').style.width = progress + '%';
            if (progress >= 100) {
                clearInterval(progressInterval);
            }
        }, 100);

        fetch('/api/run-simulation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            currentResults = data;
            displayResults(data);
            document.getElementById('simulation-loading').style.display = 'none';
            document.getElementById('results-container').style.display = 'block';
        });
    }

    function displayResults(data) {
        // Update probabilities
        document.getElementById('prob-positive').textContent = data.probabilities.positive_balance.toFixed(1) + '%';
        document.getElementById('prob-overbudget').textContent = data.probabilities.over_budget.toFixed(1) + '%';
        document.getElementById('prob-savings').textContent = data.probabilities.meet_savings_goal.toFixed(1) + '%';

        // Update scenarios
        document.getElementById('best-case').textContent = '$' + data.percentiles.p90.toFixed(2);
        document.getElementById('likely-case').textContent =
            '$' + data.percentiles.p25.toFixed(2) + ' - $' + data.percentiles.p75.toFixed(2);
        document.getElementById('worst-case').textContent = '$' + data.percentiles.p10.toFixed(2);

        // Create histogram
        const ctx = document.getElementById('histogram-chart').getContext('2d');

        if (histogramChart) {
            histogramChart.destroy();
        }

        const bins = data.histogram.bins;
        const labels = bins.slice(0, -1).map((b, i) => {
            return '$' + b.toFixed(0) + '-$' + bins[i+1].toFixed(0);
        });

        const colors = bins.slice(0, -1).map(b => {
            if (b < 0) return '#ef4444'; // Red for negative
            if (b < data.savings_goal) return '#f59e0b'; // Yellow below savings goal
            return '#10b981'; // Green above savings goal
        });

        histogramChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Number of Simulations',
                    data: data.histogram.counts,
                    backgroundColor: colors
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Simulations: ' + context.parsed.y;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Simulations'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Ending Balance'
                        }
                    }
                }
            }
        });
    }

    function runWhatIfSimulation() {
        const adjustments = {
            'Food & Groceries': parseInt(document.getElementById('adj-food').value),
            'Dining Out': parseInt(document.getElementById('adj-dining').value),
            'Entertainment': parseInt(document.getElementById('adj-entertainment').value),
            'Shopping': parseInt(document.getElementById('adj-shopping').value)
        };

        fetch('/api/run-simulation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ adjustments })
        })
        .then(response => response.json())
        .then(data => {
            const resultDiv = document.getElementById('what-if-result');
            const textDiv = document.getElementById('what-if-text');

            const probPositive = data.probabilities.positive_balance.toFixed(1);
            const range = `$${data.percentiles.p25.toFixed(2)} - $${data.percentiles.p75.toFixed(2)}`;

            textDiv.innerHTML = `
                <strong>${probPositive}%</strong> chance you'll have <strong>${range}</strong> remaining<br>
                <strong>${data.probabilities.meet_savings_goal.toFixed(1)}%</strong> chance of meeting your savings goal
            `;

            resultDiv.style.display = 'block';

            // Update the histogram too
            displayResults(data);
        });
    }
</script>
{% endblock %}
