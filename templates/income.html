{% extends "base.html" %}

{% block title %}Income - Budget Planner{% endblock %}

{% block content %}
<div class="transactions-page">
    <h1>Income Tracking & Budget Planning</h1>

    <!-- Budget Configuration -->
    <div class="card settings-section" style="margin-bottom: 20px;">
        <h2>Budget Configuration</h2>
        <p class="text-muted">Set your monthly budget and savings goals based on your income</p>

        <div class="settings-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
            <div class="setting-item">
                <label>Monthly Budget (Spending Limit)</label>
                <input type="number" id="monthly-budget" class="form-control" value="{{ user.get('monthly_budget', 0) }}" step="0.01">
            </div>
            <div class="setting-item">
                <label>Monthly Savings Goal</label>
                <input type="number" id="savings-goal" class="form-control" value="{{ user.get('savings_goal', 0) }}" step="0.01">
            </div>
        </div>

        <button onclick="updateBudget()" class="btn btn-primary">Save Budget Settings</button>
    </div>

    <div class="card total-card">
        <h3>Total Income This Month</h3>
        <div class="total-amount income-positive">${{ "%.2f"|format(total_this_month) }}</div>
    </div>

    <!-- Filters -->
    <div class="card filters-card">
        <div class="filters-row">
            <div class="filter-group">
                <label for="search-filter">Search</label>
                <input type="text" id="search-filter" class="form-control" placeholder="Description or source..." oninput="filterIncome()">
            </div>
            <div class="filter-group filter-range">
                <label>Date Range</label>
                <div class="range-inputs">
                    <input type="date" id="date-from" class="form-control" onchange="filterIncome()">
                    <span class="range-separator">to</span>
                    <input type="date" id="date-to" class="form-control" onchange="filterIncome()">
                </div>
            </div>
            <div class="filter-actions">
                <button onclick="clearFilters()" class="btn btn-secondary">Clear</button>
                <a href="/api/export/income" class="btn btn-secondary">Export CSV</a>
                <button onclick="showAddIncome()" class="btn btn-primary">Add Income</button>
            </div>
        </div>
    </div>

    <!-- Income Table -->
    <div class="card">
        <div class="table-container">
            <table class="transactions-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Source</th>
                        <th>Description</th>
                        <th>Recurring</th>
                        <th>Amount</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="income-tbody">
                    <!-- Income records will be loaded here -->
                </tbody>
            </table>
        </div>

        <div id="load-more-container" class="load-more-container">
            <button id="load-more-btn" onclick="loadMoreIncome()" class="btn btn-secondary">
                Load More Records
            </button>
        </div>
    </div>
</div>

<!-- Add Income Modal -->
<div id="add-income-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Add Income</h2>

        <form id="income-form" onsubmit="submitIncome(event)">
            <div class="form-group">
                <label for="income-date">Date</label>
                <input type="date" id="income-date" class="form-control" required>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="income-amount">Amount</label>
                    <input type="number" id="income-amount" class="form-control" step="0.01" required>
                </div>

                <div class="form-group">
                    <label for="income-currency">Currency</label>
                    <select id="income-currency" class="form-control">
                        <option value="USD" selected>USD</option>
                        <option value="EUR">EUR</option>
                        <option value="GBP">GBP</option>
                        <option value="JPY">JPY</option>
                        <option value="CAD">CAD</option>
                        <option value="AUD">AUD</option>
                        <option value="CHF">CHF</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="income-source">Source</label>
                <select id="income-source" class="form-control" required>
                    <option value="">Select Source</option>
                    <option value="Salary">Salary</option>
                    <option value="Freelance">Freelance</option>
                    <option value="Investment">Investment</option>
                    <option value="Business">Business</option>
                    <option value="Gift">Gift</option>
                    <option value="Bonus">Bonus</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="form-group">
                <label for="income-description">Description (optional)</label>
                <input type="text" id="income-description" class="form-control">
            </div>

            <div class="form-group checkbox-group">
                <label>
                    <input type="checkbox" id="income-recurring" onchange="toggleRecurring()">
                    Recurring Income
                </label>
            </div>

            <div class="form-group" id="frequency-group" style="display: none;">
                <label for="income-frequency">Frequency</label>
                <select id="income-frequency" class="form-control">
                    <option value="weekly">Weekly</option>
                    <option value="bi-weekly">Bi-Weekly</option>
                    <option value="monthly" selected>Monthly</option>
                    <option value="annually">Annually</option>
                </select>
            </div>

            <div class="button-group">
                <button type="button" onclick="closeModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Income</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    let currentOffset = 0;
    const limit = 50;
    let currentFilters = {
        search: '',
        dateFrom: '',
        dateTo: ''
    };

    // Set today's date as default
    const today = new Date();
    document.getElementById('income-date').valueAsDate = today;
    document.getElementById('date-to').valueAsDate = today;

    // Load initial income records
    loadIncome();

    function toggleRecurring() {
        const recurring = document.getElementById('income-recurring').checked;
        const frequencyGroup = document.getElementById('frequency-group');
        frequencyGroup.style.display = recurring ? 'block' : 'none';
    }

    function loadIncome(append = false) {
        const params = new URLSearchParams({
            offset: currentOffset,
            limit: limit,
            date_from: currentFilters.dateFrom,
            date_to: currentFilters.dateTo
        });

        const url = `/api/income?${params.toString()}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('income-tbody');

                if (!append) {
                    tbody.innerHTML = '';
                }

                if (data.income.length === 0 && !append) {
                    tbody.innerHTML = '<tr><td colspan="6" class="no-data">No income records found</td></tr>';
                } else {
                    data.income.forEach(income => {
                        // Filter by search if needed
                        if (currentFilters.search) {
                            const searchLower = currentFilters.search.toLowerCase();
                            const matchesSearch =
                                (income.source && income.source.toLowerCase().includes(searchLower)) ||
                                (income.description && income.description.toLowerCase().includes(searchLower));
                            if (!matchesSearch) return;
                        }

                        const row = createIncomeRow(income);
                        tbody.appendChild(row);
                    });
                }

                // Show/hide load more button
                const loadMoreBtn = document.getElementById('load-more-btn');
                if (data.has_more) {
                    loadMoreBtn.style.display = 'block';
                } else {
                    loadMoreBtn.style.display = 'none';
                }
            });
    }

    function createIncomeRow(income) {
        const row = document.createElement('tr');
        const date = new Date(income.date).toLocaleDateString();
        const recurringBadge = income.recurring ?
            `<span class="recurring-badge">${income.frequency}</span>` :
            '<span class="one-time-badge">one-time</span>';

        row.innerHTML = `
            <td>${date}</td>
            <td>${income.source}</td>
            <td>${income.description || '-'}</td>
            <td>${recurringBadge}</td>
            <td class="amount income-positive">$${income.amount.toFixed(2)}</td>
            <td>
                <button onclick="deleteIncome(${income.id})" class="btn btn-danger-small">Delete</button>
            </td>
        `;

        return row;
    }

    function loadMoreIncome() {
        currentOffset += limit;
        loadIncome(true);
    }

    function filterIncome() {
        currentFilters.search = document.getElementById('search-filter').value;
        currentFilters.dateFrom = document.getElementById('date-from').value;
        currentFilters.dateTo = document.getElementById('date-to').value;
        currentOffset = 0;
        loadIncome(false);
    }

    function clearFilters() {
        document.getElementById('search-filter').value = '';
        document.getElementById('date-from').value = '';
        document.getElementById('date-to').value = '';
        currentFilters = {
            search: '',
            dateFrom: '',
            dateTo: ''
        };
        currentOffset = 0;
        loadIncome(false);
    }

    function deleteIncome(id) {
        if (confirm('Are you sure you want to delete this income record?')) {
            fetch(`/api/delete-income/${id}`, {
                method: 'DELETE'
            })
            .then(() => {
                currentOffset = 0;
                loadIncome(false);
            });
        }
    }

    function showAddIncome() {
        document.getElementById('add-income-modal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('add-income-modal').style.display = 'none';
    }

    function submitIncome(event) {
        event.preventDefault();

        const recurring = document.getElementById('income-recurring').checked;
        const data = {
            date: document.getElementById('income-date').value,
            amount: parseFloat(document.getElementById('income-amount').value),
            currency: document.getElementById('income-currency').value,
            source: document.getElementById('income-source').value,
            description: document.getElementById('income-description').value,
            recurring: recurring,
            frequency: recurring ? document.getElementById('income-frequency').value : 'one-time'
        };

        fetch('/api/income', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                closeModal();
                currentOffset = 0;
                loadIncome(false);
                document.getElementById('income-form').reset();
                document.getElementById('income-date').valueAsDate = new Date();
                document.getElementById('frequency-group').style.display = 'none';
                location.reload(); // Reload to update total
            }
        });
    }

    function updateBudget() {
        const data = {
            monthly_budget: parseFloat(document.getElementById('monthly-budget').value),
            savings_goal: parseFloat(document.getElementById('savings-goal').value)
        };

        fetch('/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('Budget settings updated successfully!');
            } else {
                alert('Error updating budget settings');
            }
        });
    }

    window.onclick = function(event) {
        const modal = document.getElementById('add-income-modal');
        if (event.target == modal) {
            closeModal();
        }
    }
</script>
{% endblock %}
