{% extends "base.html" %}

{% block title %}Transactions - Budget Planner{% endblock %}

{% block content %}
<div class="transactions-page">
    <h1>All Transactions</h1>

    <div class="card total-card">
        <h3>Total Spent This Month</h3>
        <div class="total-amount">${{ "%.2f"|format(total_this_month) }}</div>
    </div>

    <!-- Filters -->
    <div class="card filters-card">
        <div class="filters-row">
            <div class="filter-group">
                <label for="category-filter">Category</label>
                <select id="category-filter" class="form-control" onchange="filterTransactions()">
                    <option value="all">All Categories</option>
                    <option value="Food & Groceries">Food & Groceries</option>
                    <option value="Dining Out">Dining Out</option>
                    <option value="Entertainment">Entertainment</option>
                    <option value="Transportation">Transportation</option>
                    <option value="Shopping">Shopping</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="search-filter">Search</label>
                <input type="text" id="search-filter" class="form-control" placeholder="Description..." oninput="filterTransactions()">
            </div>
            <div class="filter-group filter-range">
                <label>Date Range</label>
                <div class="range-inputs">
                    <input type="date" id="date-from" class="form-control" onchange="filterTransactions()">
                    <span class="range-separator">to</span>
                    <input type="date" id="date-to" class="form-control" onchange="filterTransactions()">
                </div>
            </div>
            <div class="filter-group filter-range">
                <label>Amount Range</label>
                <div class="range-inputs">
                    <input type="number" id="amount-min" class="form-control" placeholder="$0" step="0.01" oninput="filterTransactions()">
                    <span class="range-separator">to</span>
                    <input type="number" id="amount-max" class="form-control" placeholder="Any" step="0.01" oninput="filterTransactions()">
                </div>
            </div>
            <div class="filter-actions">
                <button onclick="clearFilters()" class="btn btn-secondary">Clear</button>
                <button onclick="showAddTransaction()" class="btn btn-primary">Add Transaction</button>
            </div>
        </div>
    </div>

    <!-- Transactions Table -->
    <div class="card">
        <div class="table-container">
            <table class="transactions-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Category</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="transactions-tbody">
                    <!-- Transactions will be loaded here -->
                </tbody>
            </table>
        </div>

        <div id="load-more-container" class="load-more-container">
            <button id="load-more-btn" onclick="loadMoreTransactions()" class="btn btn-secondary">
                Load More Transactions
            </button>
        </div>
    </div>
</div>

<!-- Add Transaction Modal (same as dashboard) -->
<div id="add-transaction-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Add New Transaction</h2>

        <form id="transaction-form" onsubmit="submitTransaction(event)">
            <div class="form-group">
                <label for="transaction-date">Date</label>
                <input type="date" id="transaction-date" class="form-control" required>
            </div>

            <div class="form-group">
                <label for="transaction-amount">Amount ($)</label>
                <input type="number" id="transaction-amount" class="form-control" step="0.01" required>
            </div>

            <div class="form-group">
                <label for="transaction-category">Category</label>
                <select id="transaction-category" class="form-control" required>
                    <option value="">Select Category</option>
                    <option value="Food & Groceries">Food & Groceries</option>
                    <option value="Dining Out">Dining Out</option>
                    <option value="Entertainment">Entertainment</option>
                    <option value="Transportation">Transportation</option>
                    <option value="Shopping">Shopping</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="form-group">
                <label for="transaction-description">Description (optional)</label>
                <input type="text" id="transaction-description" class="form-control">
            </div>

            <div class="button-group">
                <button type="button" onclick="closeModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Transaction</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    let currentOffset = 0;
    const limit = 20;
    let currentFilters = {
        category: 'all',
        search: '',
        dateFrom: '',
        dateTo: '',
        amountMin: '',
        amountMax: ''
    };

    // Set today's date as default for transaction form and filter
    const today = new Date();
    document.getElementById('transaction-date').valueAsDate = today;
    document.getElementById('date-to').valueAsDate = today;

    // Load initial transactions
    loadTransactions();

    function loadTransactions(append = false) {
        const params = new URLSearchParams({
            offset: currentOffset,
            limit: limit,
            category: currentFilters.category,
            search: currentFilters.search,
            date_from: currentFilters.dateFrom,
            date_to: currentFilters.dateTo,
            amount_min: currentFilters.amountMin,
            amount_max: currentFilters.amountMax
        });

        const url = `/api/transactions?${params.toString()}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('transactions-tbody');

                if (!append) {
                    tbody.innerHTML = '';
                }

                if (data.transactions.length === 0 && !append) {
                    tbody.innerHTML = '<tr><td colspan="5" class="no-data">No transactions found</td></tr>';
                } else {
                    data.transactions.forEach(t => {
                        const row = createTransactionRow(t);
                        tbody.appendChild(row);
                    });
                }

                // Show/hide load more button
                const loadMoreBtn = document.getElementById('load-more-btn');
                if (data.has_more) {
                    loadMoreBtn.style.display = 'block';
                } else {
                    loadMoreBtn.style.display = 'none';
                }
            });
    }

    function createTransactionRow(transaction) {
        const row = document.createElement('tr');
        if (transaction.is_anomaly) {
            row.classList.add('anomaly-row');
        }

        const date = new Date(transaction.date).toLocaleDateString();
        const anomalyIndicator = transaction.is_anomaly ? '<span class="anomaly-badge">üî¥</span> ' : '';

        row.innerHTML = `
            <td>${date}</td>
            <td>${transaction.category}</td>
            <td>${anomalyIndicator}${transaction.description || '-'}</td>
            <td class="amount">$${transaction.amount.toFixed(2)}</td>
            <td>
                <button onclick="deleteTransaction(${transaction.id})" class="btn btn-danger-small">Delete</button>
            </td>
        `;

        return row;
    }

    function loadMoreTransactions() {
        currentOffset += limit;
        loadTransactions(true);
    }

    function filterTransactions() {
        currentFilters.category = document.getElementById('category-filter').value;
        currentFilters.search = document.getElementById('search-filter').value;
        currentFilters.dateFrom = document.getElementById('date-from').value;
        currentFilters.dateTo = document.getElementById('date-to').value;
        currentFilters.amountMin = document.getElementById('amount-min').value;
        currentFilters.amountMax = document.getElementById('amount-max').value;
        currentOffset = 0;
        loadTransactions(false);
    }

    function clearFilters() {
        document.getElementById('category-filter').value = 'all';
        document.getElementById('search-filter').value = '';
        document.getElementById('date-from').value = '';
        document.getElementById('date-to').value = '';
        document.getElementById('amount-min').value = '';
        document.getElementById('amount-max').value = '';
        currentFilters = {
            category: 'all',
            search: '',
            dateFrom: '',
            dateTo: '',
            amountMin: '',
            amountMax: ''
        };
        currentOffset = 0;
        loadTransactions(false);
    }

    function deleteTransaction(id) {
        if (confirm('Are you sure you want to delete this transaction?')) {
            fetch(`/api/delete-transaction/${id}`, {
                method: 'DELETE'
            })
            .then(() => {
                currentOffset = 0;
                loadTransactions(false);
            });
        }
    }

    function showAddTransaction() {
        document.getElementById('add-transaction-modal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('add-transaction-modal').style.display = 'none';
    }

    function submitTransaction(event) {
        event.preventDefault();

        const data = {
            date: document.getElementById('transaction-date').value,
            amount: parseFloat(document.getElementById('transaction-amount').value),
            category: document.getElementById('transaction-category').value,
            description: document.getElementById('transaction-description').value
        };

        fetch('/api/transactions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                if (result.is_anomaly) {
                    alert(`‚ö†Ô∏è Unusual Transaction Detected!\n\nThis transaction is ${Math.abs(result.z_score).toFixed(2)} standard deviations from your average.`);
                }
                closeModal();
                currentOffset = 0;
                loadTransactions(false);
                document.getElementById('transaction-form').reset();
                document.getElementById('transaction-date').valueAsDate = new Date();
            }
        });
    }

    window.onclick = function(event) {
        const modal = document.getElementById('add-transaction-modal');
        if (event.target == modal) {
            closeModal();
        }
    }
</script>
{% endblock %}
