{% extends "base.html" %}

{% block title %}Transactions - Budget Planner{% endblock %}

{% block content %}
<div class="transactions-page">
    <h1>All Transactions</h1>

    <div class="card total-card">
        <h3>Total Spent This Month</h3>
        <div class="total-amount">${{ "%.2f"|format(total_this_month) }}</div>
    </div>

    <!-- Filters -->
    <div class="card filters-card">
        <div class="filters-row">
            <div class="filter-group">
                <label for="category-filter">Category</label>
                <select id="category-filter" class="form-control" onchange="filterTransactions()">
                    <option value="all">All Categories</option>
                    <option value="Food & Groceries">Food & Groceries</option>
                    <option value="Dining Out">Dining Out</option>
                    <option value="Entertainment">Entertainment</option>
                    <option value="Transportation">Transportation</option>
                    <option value="Shopping">Shopping</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="search-filter">Search</label>
                <input type="text" id="search-filter" class="form-control" placeholder="Description..." oninput="filterTransactions()">
            </div>
            <div class="filter-group filter-range">
                <label>Date Range</label>
                <div class="range-inputs">
                    <input type="date" id="date-from" class="form-control" onchange="filterTransactions()">
                    <span class="range-separator">to</span>
                    <input type="date" id="date-to" class="form-control" onchange="filterTransactions()">
                </div>
            </div>
            <div class="filter-group filter-range">
                <label>Amount Range</label>
                <div class="range-inputs">
                    <input type="number" id="amount-min" class="form-control" placeholder="$0" step="0.01" oninput="filterTransactions()">
                    <span class="range-separator">to</span>
                    <input type="number" id="amount-max" class="form-control" placeholder="Any" step="0.01" oninput="filterTransactions()">
                </div>
            </div>
            <div class="filter-actions">
                <button onclick="clearFilters()" class="btn btn-secondary">Clear</button>
                <a href="/api/export/transactions" class="btn btn-secondary">Export CSV</a>
                <button onclick="showAddTransaction()" class="btn btn-primary">Add Transaction</button>
            </div>
        </div>
    </div>

    <!-- Transactions Table -->
    <div class="card">
        <div class="table-container">
            <table class="transactions-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Category</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="transactions-tbody">
                    <!-- Transactions will be loaded here -->
                </tbody>
            </table>
        </div>

        <div id="load-more-container" class="load-more-container">
            <button id="load-more-btn" onclick="loadMoreTransactions()" class="btn btn-secondary">
                Load More Transactions
            </button>
        </div>
    </div>

    <!-- Recurring Transactions Section -->
    <div class="card" style="margin-top: 30px;">
        <h2 style="margin-bottom: 15px;">Recurring Transactions</h2>
        <p class="text-muted" style="margin-bottom: 20px;">Manage your subscriptions and automatic transactions. Transactions will be automatically created on their due date.</p>

        <div class="button-group" style="margin-bottom: 20px;">
            <button onclick="showAddRecurring()" class="btn btn-primary">Add Recurring Transaction</button>
            <button onclick="generateRecurringNow()" class="btn btn-secondary">Generate Due Transactions Now</button>
        </div>

        <div class="table-container">
            <table class="transactions-table">
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>Category</th>
                        <th>Amount</th>
                        <th>Frequency</th>
                        <th>Next Due</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="recurring-tbody">
                    <!-- Recurring transactions will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Transaction Modal (same as dashboard) -->
<div id="add-transaction-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Add New Transaction</h2>

        <form id="transaction-form" onsubmit="submitTransaction(event)">
            <div class="form-group">
                <label for="transaction-date">Date</label>
                <input type="date" id="transaction-date" class="form-control" required>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="transaction-amount">Amount</label>
                    <input type="number" id="transaction-amount" class="form-control" step="0.01" required>
                </div>

                <div class="form-group">
                    <label for="transaction-currency">Currency</label>
                    <select id="transaction-currency" class="form-control">
                        <option value="USD" selected>USD</option>
                        <option value="EUR">EUR</option>
                        <option value="GBP">GBP</option>
                        <option value="JPY">JPY</option>
                        <option value="CAD">CAD</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="transaction-category">Category</label>
                <select id="transaction-category" class="form-control" required>
                    <option value="">Select Category</option>
                    <option value="Food & Groceries">Food & Groceries</option>
                    <option value="Dining Out">Dining Out</option>
                    <option value="Entertainment">Entertainment</option>
                    <option value="Transportation">Transportation</option>
                    <option value="Shopping">Shopping</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="form-group">
                <label for="transaction-description">Description (optional)</label>
                <input type="text" id="transaction-description" class="form-control">
            </div>

            <div class="button-group">
                <button type="button" onclick="closeModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Transaction</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Recurring Transaction Modal -->
<div id="add-recurring-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeRecurringModal()">&times;</span>
        <h2>Add Recurring Transaction</h2>
        <form id="recurring-form" onsubmit="submitRecurring(event)">
            <div class="form-group">
                <label for="recurring-description">Description</label>
                <input type="text" id="recurring-description" class="form-control" placeholder="e.g., Netflix Subscription" required>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="recurring-amount">Amount</label>
                    <input type="number" id="recurring-amount" class="form-control" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="recurring-currency">Currency</label>
                    <select id="recurring-currency" class="form-control">
                        <option value="USD" selected>USD</option>
                        <option value="EUR">EUR</option>
                        <option value="GBP">GBP</option>
                        <option value="JPY">JPY</option>
                        <option value="CAD">CAD</option>
                        <option value="AUD">AUD</option>
                        <option value="CHF">CHF</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="recurring-category">Category</label>
                <select id="recurring-category" class="form-control" required>
                    <option value="">Select Category</option>
                    <option value="Food & Groceries">Food & Groceries</option>
                    <option value="Dining Out">Dining Out</option>
                    <option value="Entertainment">Entertainment</option>
                    <option value="Transportation">Transportation</option>
                    <option value="Shopping">Shopping</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="form-group">
                <label for="recurring-frequency">Frequency</label>
                <select id="recurring-frequency" class="form-control" required>
                    <option value="weekly">Weekly</option>
                    <option value="bi-weekly">Bi-Weekly</option>
                    <option value="monthly" selected>Monthly</option>
                    <option value="quarterly">Quarterly</option>
                    <option value="annually">Annually</option>
                </select>
            </div>

            <div class="form-group">
                <label for="recurring-start-date">Start Date</label>
                <input type="date" id="recurring-start-date" class="form-control" required>
            </div>

            <div class="button-group">
                <button type="button" onclick="closeRecurringModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Recurring Transaction</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    let currentOffset = 0;
    const limit = 20;
    let currentFilters = {
        category: 'all',
        search: '',
        dateFrom: '',
        dateTo: '',
        amountMin: '',
        amountMax: ''
    };

    // Set today's date as default for transaction form and filter
    const today = new Date();
    document.getElementById('transaction-date').valueAsDate = today;
    document.getElementById('date-to').valueAsDate = today;

    // Load initial transactions
    loadTransactions();

    function loadTransactions(append = false) {
        const params = new URLSearchParams({
            offset: currentOffset,
            limit: limit,
            category: currentFilters.category,
            search: currentFilters.search,
            date_from: currentFilters.dateFrom,
            date_to: currentFilters.dateTo,
            amount_min: currentFilters.amountMin,
            amount_max: currentFilters.amountMax
        });

        const url = `/api/transactions?${params.toString()}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('transactions-tbody');

                if (!append) {
                    tbody.innerHTML = '';
                }

                if (data.transactions.length === 0 && !append) {
                    tbody.innerHTML = '<tr><td colspan="5" class="no-data">No transactions found</td></tr>';
                } else {
                    data.transactions.forEach(t => {
                        const row = createTransactionRow(t);
                        tbody.appendChild(row);
                    });
                }

                // Show/hide load more button
                const loadMoreBtn = document.getElementById('load-more-btn');
                if (data.has_more) {
                    loadMoreBtn.style.display = 'block';
                } else {
                    loadMoreBtn.style.display = 'none';
                }
            });
    }

    function createTransactionRow(transaction) {
        const row = document.createElement('tr');
        if (transaction.is_anomaly) {
            row.classList.add('anomaly-row');
        }

        const date = new Date(transaction.date).toLocaleDateString();
        const anomalyIndicator = transaction.is_anomaly ? '<span class="anomaly-badge">ðŸ”´</span> ' : '';

        row.innerHTML = `
            <td>${date}</td>
            <td>${transaction.category}</td>
            <td>${anomalyIndicator}${transaction.description || '-'}</td>
            <td class="amount">$${transaction.amount.toFixed(2)}</td>
            <td>
                <button onclick="deleteTransaction(${transaction.id})" class="btn btn-danger-small">Delete</button>
            </td>
        `;

        return row;
    }

    function loadMoreTransactions() {
        currentOffset += limit;
        loadTransactions(true);
    }

    function filterTransactions() {
        currentFilters.category = document.getElementById('category-filter').value;
        currentFilters.search = document.getElementById('search-filter').value;
        currentFilters.dateFrom = document.getElementById('date-from').value;
        currentFilters.dateTo = document.getElementById('date-to').value;
        currentFilters.amountMin = document.getElementById('amount-min').value;
        currentFilters.amountMax = document.getElementById('amount-max').value;
        currentOffset = 0;
        loadTransactions(false);
    }

    function clearFilters() {
        document.getElementById('category-filter').value = 'all';
        document.getElementById('search-filter').value = '';
        document.getElementById('date-from').value = '';
        document.getElementById('date-to').value = '';
        document.getElementById('amount-min').value = '';
        document.getElementById('amount-max').value = '';
        currentFilters = {
            category: 'all',
            search: '',
            dateFrom: '',
            dateTo: '',
            amountMin: '',
            amountMax: ''
        };
        currentOffset = 0;
        loadTransactions(false);
    }

    function deleteTransaction(id) {
        if (confirm('Are you sure you want to delete this transaction?')) {
            fetch(`/api/delete-transaction/${id}`, {
                method: 'DELETE'
            })
            .then(() => {
                currentOffset = 0;
                loadTransactions(false);
            });
        }
    }

    function showAddTransaction() {
        document.getElementById('add-transaction-modal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('add-transaction-modal').style.display = 'none';
    }

    function submitTransaction(event) {
        event.preventDefault();

        const data = {
            date: document.getElementById('transaction-date').value,
            amount: parseFloat(document.getElementById('transaction-amount').value),
            category: document.getElementById('transaction-category').value,
            description: document.getElementById('transaction-description').value,
            currency: document.getElementById('transaction-currency').value
        };

        fetch('/api/transactions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                if (result.is_anomaly) {
                    alert(`âš ï¸ Unusual Transaction Detected!\n\nThis transaction is ${Math.abs(result.z_score).toFixed(2)} standard deviations from your average.`);
                }
                closeModal();
                currentOffset = 0;
                loadTransactions(false);
                document.getElementById('transaction-form').reset();
                document.getElementById('transaction-date').valueAsDate = new Date();
            }
        });
    }

    // Recurring Transactions Functions
    function loadRecurringTransactions() {
        fetch('/api/recurring-transactions')
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('recurring-tbody');
                tbody.innerHTML = '';

                if (data.recurring.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="no-data">No recurring transactions found. Add your first recurring transaction!</td></tr>';
                    return;
                }

                data.recurring.forEach(rec => {
                    const row = document.createElement('tr');
                    const nextDue = rec.next_due_date ? new Date(rec.next_due_date).toLocaleDateString() : '-';
                    const statusBadge = rec.is_active ? '<span class="badge badge-success">Active</span>' : '<span class="badge badge-secondary">Inactive</span>';

                    row.innerHTML = `
                        <td>${rec.description}</td>
                        <td>${rec.category}</td>
                        <td>$${rec.amount.toFixed(2)} ${rec.currency}</td>
                        <td>${rec.frequency}</td>
                        <td>${nextDue}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button onclick="toggleRecurring(${rec.id}, ${!rec.is_active})" class="btn btn-secondary-small">
                                ${rec.is_active ? 'Deactivate' : 'Activate'}
                            </button>
                            <button onclick="deleteRecurring(${rec.id})" class="btn btn-danger-small">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            });
    }

    function showAddRecurring() {
        document.getElementById('add-recurring-modal').style.display = 'block';
        document.getElementById('recurring-start-date').valueAsDate = new Date();
    }

    function closeRecurringModal() {
        document.getElementById('add-recurring-modal').style.display = 'none';
    }

    function submitRecurring(event) {
        event.preventDefault();

        const data = {
            amount: parseFloat(document.getElementById('recurring-amount').value),
            category: document.getElementById('recurring-category').value,
            description: document.getElementById('recurring-description').value,
            currency: document.getElementById('recurring-currency').value,
            frequency: document.getElementById('recurring-frequency').value,
            start_date: document.getElementById('recurring-start-date').value
        };

        fetch('/api/recurring-transactions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                closeRecurringModal();
                loadRecurringTransactions();
                document.getElementById('recurring-form').reset();
                alert('Recurring transaction added successfully!');
            }
        });
    }

    function toggleRecurring(id, activate) {
        fetch(`/api/recurring-transactions/${id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_active: activate })
        })
        .then(() => loadRecurringTransactions());
    }

    function deleteRecurring(id) {
        if (confirm('Are you sure you want to delete this recurring transaction?')) {
            fetch(`/api/recurring-transactions/${id}`, {
                method: 'DELETE'
            })
            .then(() => loadRecurringTransactions());
        }
    }

    function generateRecurringNow() {
        if (confirm('Generate all due recurring transactions now?')) {
            fetch('/api/recurring-transactions/generate', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(result => {
                alert(`Generated ${result.generated} transactions!`);
                loadTransactions(false);
                loadRecurringTransactions();
            });
        }
    }

    window.onclick = function(event) {
        const transactionModal = document.getElementById('add-transaction-modal');
        const recurringModal = document.getElementById('add-recurring-modal');
        if (event.target == transactionModal) {
            closeModal();
        }
        if (event.target == recurringModal) {
            closeRecurringModal();
        }
    }

    // Load recurring transactions on page load
    loadRecurringTransactions();
</script>
{% endblock %}
